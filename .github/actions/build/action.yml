name: Build action
description: Build action
runs:
  using: "composite"
  steps:
    - name: Create Dir
      shell: nu {0}
      run: |
        mkdir angle $env.BuildDir
        mv args.gn $env.BuildDir

    - name: Fetch source
      working-directory: angle
      shell: nu {0}
      run: |
        git init
        git remote add origin https://github.com/google/angle.git
        git fetch --depth 1 origin chromium/($env.ANGLE_Branch)
        git checkout chromium/($env.ANGLE_Branch)
        git apply -v ../patch/chromium-($env.ANGLE_Branch)-deps.patch

    - name: Restore source cache
      uses: actions/cache/restore@v4
      id: restore-src-cache
      with:
        path: |
          angle/build
          angle/buildtools
          angle/third_party
          angle/tools
        key: ${{ runner.os }}-src-cache-${{ env.ANGLE_Branch }}

    - name: Sync source
      working-directory: angle
      shell: nu {0}
      run: |
        uv run --python 3.12 -- python scripts/bootstrap.py
        gclient sync -f -D -R

    - name: Save src cache immediately
      id: save-src-cache
      if: always() && steps.restore-src-cache.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        key: ${{ steps.restore-src-cache.outputs.cache-primary-key }}
        path: |
          angle/build
          angle/buildtools
          angle/third_party
          angle/tools

    - name: Move Build.gn
      working-directory: ${{github.workspace}}
      shell: nu {0}
      # git diff --patch > chromium-7151.patch
      run: mv -f BUILD.gn angle

    - name: Build ANGLE
      working-directory: angle
      shell: nu {0}
      run: |
        gn gen $env.BuildDir
        autoninja -C $env.BuildDir libANGLE_static libGLESv2_static

    - name: Package ANGLE
      working-directory: ${{github.workspace}}
      shell: nu {0}
      run: |
        cd $"($env.BuildDir)/obj"
        7z a -y -mx9 $"($env.ANGLEStaticName).7z" libANGLE_static.lib libGLESv2_static.lib
        mv $"($env.ANGLEStaticName).7z" $env.GITHUB_WORKSPACE

    - name: dotnet pack
      shell: nu {0}
      run: dotnet pack nuget/ANGLE.Static.csproj -p $"version=($env.ANGLE_Branch)-($env.UCRTVersion)-($env.BuildVersion)" -o $"($env.GITHUB_WORKSPACE)"
